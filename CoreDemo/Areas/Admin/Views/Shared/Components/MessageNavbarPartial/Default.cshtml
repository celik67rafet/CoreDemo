@using CoreDemo.Areas.Admin.Models
@model MessageAllModelView

<div class="col-lg-3">
    <div class="ibox ">
        <div class="ibox-content mailbox-content">
            <div class="file-manager">
                <a class="btn btn-block btn-primary compose-mail" id="openMessageDialog" href="#" data-toggle="modal" data-target="#composeMailModal">Mesaj Oluştur</a>
                <div class="space-25"></div>
                <h5>MESAJLAR</h5>
                <ul class="folder-list m-b-md" style="padding: 0">
                    <li>
                        <a href="/Admin/Message/Inbox">
                            <i class="fa fa-inbox "></i> Gelen Mesajlar

                            @if (Model.Inbox.Where(x => x.MessageStatus == true).Count() > 0)
                            {
                                <span class="label label-warning float-right">@Model.Inbox.Where(x => x.MessageStatus == true).Count()</span>
                            }

                        </a>
                    </li>
                    <li>
                        <a href="/Admin/Message/SendBox">
                            <i class="fa fa-envelope-o"></i> Giden Mesajlar

                            @if (Model.SendBox.Where( x => x.VisibleInSandBox == true ).Count() > 0)
                            {
                                <span class="label label-warning float-right">@Model.SendBox.Where(x => x.VisibleInSandBox == true && x.ReceiverUser != null).Count()</span>
                            }

                        </a>
                    </li>
                    <li>
                        <a href="/Admin/Message/MessageTrashBox">
                            <i class="fa fa-trash-o"></i> Çöp Kutusu

                            @if (Model.Inbox.Where(x => x.MessageStatus == false).Count() > 0)
                            {
                                <span class="label label-danger float-right">@Model.Inbox.Where(x => x.MessageStatus == false).Count()</span>
                            }

                        </a>
                    </li>
                </ul>

                <div class="clearfix"></div>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap Modal Yapısı -->
<div class="modal fade" id="composeMailModal" tabindex="-1" role="dialog" aria-labelledby="composeMailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="composeMailModalLabel">Yeni Mesaj Oluştur</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <!-- Form burada olacak -->
                <form method="post" id="sendMessageForm">
                    <div class="col-lg-12 px-0 pb-3">
                        <label for="receiver">Alıcı:</label>
                        <select class="form-control" id="receiver">
                            
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="subject">Konu:</label>
                        <input type="text" class="form-control" id="subject" name="Subject" required>
                    </div>
                    <div class="form-group">
                        <label for="message">Mesaj:</label>
                        <textarea class="form-control" id="message" name="MessageBody" rows="5" required></textarea>
                    </div>
                </form>
                    <button id="sendMessage" class="btn btn-primary">Gönder</button>
                <div id="responseMessage" style="margin-top: 10px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    $(document).ready(function () {

        $('#sendMessage').on('click', function () {

            var formData = {

                ReceiverID: parseInt($('#receiver').val()),
                Subject : $('#subject').val(),
                MessageDetails : $('#message').val()


            }

            if (isNaN(formData.ReceiverID) ){

                $('#responseMessage').addClass("text-danger");
                $('#responseMessage').text("Alıcı seçimi yapmadınız!");


            }else{

                if (( formData.Subject === '' ) || ( formData.Subject === ' ' ) || !formData.Subject || formData.Subject.trim() === '') 
                {
                    $('#responseMessage').addClass( "text-danger" );
                    $('#responseMessage').text("Konu boş olmamalı!");

                } else 
                {
                    $.ajax({


                        url: '/Admin/Message/SendMessage',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(formData),
                        dataType: 'json',
                        success: function (data) {

                            console.log(data);

                            $('#responseMessage').removeClass("text-danger");
                            $('#responseMessage').addClass("text-success");
                            $('#responseMessage').text(data.message);

                            setTimeout(function () {
                                window.location.href = "SendBox";
                            }, 1000);
                        },
                        error: function (xhr, status, error) {

                            console.log(error);

                        }
                    })
                };

               

            }

           

            console.log( formData );

        })

        $('#openMessageDialog').on('click', function () {
            $.ajax({
                url: '/Admin/Message/SendMessage',
                type: 'GET',
                dataType: 'json',
                success: function ( data ){

                    $.each( data, function( index, item ){

                        $('#receiver').append($('<option>', {
                            value: item.writerID,
                            text: item.writerName
                        }))

                    } )


                    console.log( data.message );

                },
                error: function () {

                }
            })
        })
    } )
</script>
